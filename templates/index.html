<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ü§ñ RoboFleet AI | Smart Warehouse Digital Twin</title>
    <link rel="stylesheet" href="/static/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ü§ñ</text></svg>">
</head>
<body>
    <div class="container">
        <!-- Header -->
        <header class="dashboard-header">
            <div class="header-left">
                <h1><i class="fas fa-robot"></i> RoboFleet AI Manager</h1>
                <p class="subtitle">Digital Twin Dashboard for Smart Warehouse Operations</p>
            </div>
            <div class="header-right">
                <div class="simulation-status" id="simStatus">
                    <span class="status-indicator"></span>
                    <span class="status-text">SIMULATION READY</span>
                </div>
                <div class="time-display" id="currentTime">--:--:--</div>
            </div>
        </header>

        <!-- Stats Bar -->
        <div class="stats-bar">
            <div class="stat-card">
                <div class="stat-icon"><i class="fas fa-robot"></i></div>
                <div class="stat-content">
                    <div class="stat-value" id="totalRobots">4</div>
                    <div class="stat-label">Active Robots</div>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon battery"><i class="fas fa-battery-three-quarters"></i></div>
                <div class="stat-content">
                    <div class="stat-value" id="avgBattery">73%</div>
                    <div class="stat-label">Avg Battery</div>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon"><i class="fas fa-box"></i></div>
                <div class="stat-content">
                    <div class="stat-value" id="itemsToday">2,450</div>
                    <div class="stat-label">Items Today</div>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon ai"><i class="fas fa-brain"></i></div>
                <div class="stat-content">
                    <div class="stat-value" id="aiStatus">ACTIVE</div>
                    <div class="stat-label">AI Control</div>
                </div>
            </div>
        </div>

        <!-- Main Content Grid -->
        <div class="main-grid">
            <!-- Left Column -->
            <div class="left-column">
                <!-- Warehouse Digital Twin -->
                <div class="card map-card">
                    <div class="card-header">
                        <h2><i class="fas fa-warehouse"></i> Warehouse Digital Twin</h2>
                        <button class="btn-refresh" onclick="loadWarehouseMap()">
                            <i class="fas fa-sync-alt"></i> Refresh
                        </button>
                    </div>
                    <div class="map-container">
                        <div class="map-grid" id="warehouseGrid">
                            <!-- Generated by JavaScript -->
                        </div>
                        <div class="map-controls">
                            <div class="legend">
                                <div class="legend-item"><span class="legend-color robot"></span> Robot</div>
                                <div class="legend-item"><span class="legend-color charging"></span> Charging</div>
                                <div class="legend-item"><span class="legend-color item-high"></span> High Items</div>
                                <div class="legend-item"><span class="legend-color aisle"></span> Aisle</div>
                            </div>
                            <div class="map-stats">
                                <div><i class="fas fa-expand-arrows-alt"></i> Grid: 10√ó10</div>
                                <div><i class="fas fa-sync"></i> Live Updates</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- AI Command Center -->
                <div class="card ai-card">
                    <div class="card-header">
                        <h2><i class="fas fa-comments"></i> AI Command Center</h2>
                        <div class="ai-model">Mistral-7B</div>
                    </div>
                    <div class="ai-container">
                        <div class="ai-input-group">
                            <input type="text" id="aiCommandInput" 
                                   placeholder="Try: 'Optimize routes for all robots' or 'Check battery status'"
                                   onkeypress="if(event.key=='Enter') sendAICommand()">
                            <button class="btn-send" onclick="sendAICommand()">
                                <i class="fas fa-paper-plane"></i> Send
                            </button>
                        </div>
                        <div class="ai-response-box" id="aiResponseBox">
                            <div class="ai-response-header">
                                <span class="ai-badge"><i class="fas fa-robot"></i> AI Assistant</span>
                                <span class="response-time" id="responseTime">Ready</span>
                            </div>
                            <div class="ai-response-content" id="aiResponseContent">
                                Hello! I'm your AI fleet manager. I can optimize routes, monitor battery levels, and manage your warehouse robots. Try asking me something!
                            </div>
                        </div>
                        <div class="quick-commands">
                            <button class="quick-btn" onclick="quickCommand('battery')">
                                <i class="fas fa-battery-half"></i> Battery Report
                            </button>
                            <button class="quick-btn" onclick="quickCommand('optimize')">
                                <i class="fas fa-route"></i> Optimize Routes
                            </button>
                            <button class="quick-btn" onclick="quickCommand('emergency')">
                                <i class="fas fa-exclamation-triangle"></i> Emergency Stop
                            </button>
                            <button class="quick-btn" onclick="quickCommand('analytics')">
                                <i class="fas fa-chart-bar"></i> Full Analytics
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right Column -->
            <div class="right-column">
                <!-- Robot Fleet Status -->
                <div class="card fleet-card">
                    <div class="card-header">
                        <h2><i class="fas fa-list-alt"></i> Robot Fleet Status</h2>
                        <div class="last-update" id="lastRobotUpdate">--:--:--</div>
                    </div>
                    <div class="fleet-container" id="robotList">
                        <!-- Robots loaded here -->
                    </div>
                </div>

                <!-- Simulation Controls -->
                <div class="card control-card">
                    <div class="card-header">
                        <h2><i class="fas fa-gamepad"></i> Simulation Controls</h2>
                    </div>
                    <div class="controls-container">
                        <div class="control-buttons">
                            <button class="btn-start" onclick="toggleSimulation()" id="simButton">
                                <i class="fas fa-play"></i> Start AI Simulation
                            </button>
                            <button class="btn-assign" onclick="assignRandomTask()">
                                <i class="fas fa-random"></i> Assign Random Task
                            </button>
                            <button class="btn-analytics" onclick="showAnalytics()">
                                <i class="fas fa-chart-line"></i> Live Analytics
                            </button>
                        </div>
                        <div class="simulation-stats" id="simulationStats">
                            <div class="sim-stat">
                                <div class="sim-label">Runtime</div>
                                <div class="sim-value" id="simRuntime">0m 0s</div>
                            </div>
                            <div class="sim-stat">
                                <div class="sim-label">Items Processed</div>
                                <div class="sim-value" id="simItems">2,450</div>
                            </div>
                            <div class="sim-stat">
                                <div class="sim-label">Energy Saved</div>
                                <div class="sim-value" id="simEnergy">5.2 kWh</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Live Analytics -->
                <div class="card analytics-card">
                    <div class="card-header">
                        <h2><i class="fas fa-chart-pie"></i> Live Analytics</h2>
                        <button class="btn-refresh-small" onclick="updateAnalytics()">
                            <i class="fas fa-redo"></i>
                        </button>
                    </div>
                    <div class="analytics-container">
                        <div class="metric">
                            <div class="metric-header">
                                <span class="metric-title">AI Efficiency</span>
                                <span class="metric-value">96.3%</span>
                            </div>
                            <div class="progress-bar">
                                <div class="progress-fill" style="width: 96.3%"></div>
                            </div>
                        </div>
                        <div class="metric">
                            <div class="metric-header">
                                <span class="metric-title">Energy Optimization</span>
                                <span class="metric-value">87%</span>
                            </div>
                            <div class="progress-bar">
                                <div class="progress-fill" style="width: 87%"></div>
                            </div>
                        </div>
                        <div class="metric">
                            <div class="metric-header">
                                <span class="metric-title">System Uptime</span>
                                <span class="metric-value">99.7%</span>
                            </div>
                            <div class="progress-bar">
                                <div class="progress-fill" style="width: 99.7%"></div>
                            </div>
                        </div>
                        <div class="alerts-container" id="alertsContainer">
                            <!-- Alerts appear here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Footer -->
        <footer class="dashboard-footer">
            <div class="footer-left">
                <p>Built for <strong>AI Meets Robotics Hackathon 2026</strong> | Edition 1: AI-Powered Robotics</p>
                <p class="tech-stack">Flask ‚Ä¢ HuggingFace AI ‚Ä¢ WebSockets ‚Ä¢ Digital Twin Simulation</p>
            </div>
            <div class="footer-right">
                <div class="system-health">
                    <span class="health-indicator healthy"></span>
                    <span>System: <strong id="systemHealth">HEALTHY</strong></span>
                </div>
                <div class="last-update" id="lastUpdate">Last update: --:--:--</div>
            </div>
        </footer>
    </div>

    <!-- Alert Notifications Container -->
    <div id="alertContainer"></div>

    <!-- JavaScript -->
    <script>
        // ==================== GLOBAL STATE ====================
        let simulationActive = false;
        let lastAlertTime = 0;
        let alertCooldown = 3000; // 3 seconds between alerts

        // ==================== INITIALIZATION ====================
        document.addEventListener('DOMContentLoaded', function() {
            console.log('RoboFleet AI Manager Initializing...');
            updateTime();
            loadRobots();
            loadWarehouseMap();
            checkSystemHealth();

            // Start auto-refresh intervals
            setInterval(updateTime, 1000);
            setInterval(loadRobots, 5000);
            setInterval(loadWarehouseMap, 10000);
            setInterval(checkSystemHealth, 15000);
            setInterval(updateSimulationStats, 2000);

            // Initialize simulation stats
            updateSimulationStats();
        });

        // ==================== TIME FUNCTIONS ====================
        function updateTime() {
            const now = new Date();
            const timeStr = now.toLocaleTimeString();
            document.getElementById('currentTime').textContent = timeStr;
            document.getElementById('lastUpdate').textContent = `Last update: ${timeStr}`;
        }

        // ==================== ROBOT FLEET FUNCTIONS ====================
        async function loadRobots() {
            try {
                const response = await fetch('/api/robots');
                if (!response.ok) throw new Error('Network error');
                const robots = await response.json();

                let html = '';
                robots.forEach(robot => {
                    // Determine status icon and class
                    let statusIcon, statusClass;
                    switch(robot.status) {
                        case 'working': statusIcon = 'üîÑ'; statusClass = 'working'; break;
                        case 'charging': statusIcon = 'üîã'; statusClass = 'charging'; break;
                        case 'maintenance': statusIcon = 'üîß'; statusClass = 'maintenance'; break;
                        default: statusIcon = '‚èπÔ∏è'; statusClass = 'idle';
                    }

                    // Battery indicator class
                    const batteryLevel = Math.floor(robot.battery / 25);
                    const batteryClass = `battery-${batteryLevel}`;

                    html += `
                    <div class="robot-item ${statusClass}">
                        <div class="robot-header">
                            <div class="robot-name">
                                <span class="robot-icon">${statusIcon}</span>
                                <h3>${robot.name}</h3>
                                <span class="robot-type">${robot.type}</span>
                            </div>
                            <div class="robot-battery ${batteryClass}">
                                <i class="fas fa-battery-${batteryLevel >= 3 ? 'full' : batteryLevel >= 2 ? 'three-quarters' : batteryLevel >= 1 ? 'quarter' : 'empty'}"></i>
                                <span>${robot.battery}%</span>
                            </div>
                        </div>
                        <div class="robot-details">
                            <div class="detail">
                                <i class="fas fa-map-marker-alt"></i>
                                <span>${robot.location}</span>
                            </div>
                            <div class="detail">
                                <i class="fas fa-tasks"></i>
                                <span class="task-text">${robot.task}</span>
                            </div>
                            <div class="detail">
                                <i class="fas fa-tachometer-alt"></i>
                                <span>${robot.speed}</span>
                            </div>
                        </div>
                        <div class="robot-actions">
                            <button class="action-btn pick" onclick="assignTaskToRobot(${robot.id}, 'pick')">
                                <i class="fas fa-hand-paper"></i> Pick
                            </button>
                            <button class="action-btn move" onclick="assignTaskToRobot(${robot.id}, 'move')">
                                <i class="fas fa-shipping-fast"></i> Move
                            </button>
                            <button class="action-btn charge" onclick="assignTaskToRobot(${robot.id}, 'charge')">
                                <i class="fas fa-charging-station"></i> Charge
                            </button>
                        </div>
                    </div>`;
                });

                document.getElementById('robotList').innerHTML = html;
                document.getElementById('lastRobotUpdate').textContent = new Date().toLocaleTimeString();

                // Update stats bar
                const avgBattery = Math.round(robots.reduce((sum, r) => sum + r.battery, 0) / robots.length);
                document.getElementById('avgBattery').textContent = `${avgBattery}%`;
                document.getElementById('totalRobots').textContent = robots.length;

                // Check for low battery alerts
                robots.forEach(robot => {
                    if (robot.battery < 30 && canShowAlert()) {
                        showAlert(`‚ö†Ô∏è Low Battery: ${robot.name} at ${robot.battery}%`, 'warning');
                    }
                });

            } catch (error) {
                console.error('Error loading robots:', error);
                showAlert('‚ö†Ô∏è Could not load robot data. Retrying...', 'error');
            }
        }

        async function assignTaskToRobot(robotId, taskType) {
            try {
                const response = await fetch('/api/task/assign', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({robot_id: robotId, task_type: taskType})
                });

                const result = await response.json();
                if (result.success) {
                    showAlert(`‚úÖ ${result.message} | ${result.ai_optimization}`, 'success');
                    loadRobots();
                }
            } catch (error) {
                showAlert('‚ùå Error assigning task', 'error');
            }
        }

        // ==================== WAREHOUSE MAP FUNCTIONS ====================
        async function loadWarehouseMap() {
            try {
                const response = await fetch('/api/warehouse/map');
                const mapData = await response.json();

                let html = '';
                mapData.forEach(row => {
                    row.forEach(cell => {
                        let cellClass = 'map-cell';
                        let cellContent = '';

                        // Determine cell type
                        if (cell.has_robot) {
                            cellClass += ' robot-cell';
                            cellContent = 'ü§ñ';
                        } else if (cell.cell_type === 'charging') {
                            cellClass += ' charging-cell';
                            cellContent = '‚ö°';
                        } else if (cell.item_count > 5) {
                            cellClass += ' item-high-cell';
                            cellContent = 'üì¶';
                        } else if (cell.item_count > 0) {
                            cellClass += ' item-cell';
                            cellContent = 'üì¶';
                        } else {
                            cellClass += ' empty-cell';
                        }

                        // Add cell type class
                        cellClass += ` ${cell.cell_type}-cell`;

                        html += `<div class="${cellClass}" title="${cell.id}: ${cell.item_count} items">
                            ${cellContent}
                        </div>`;
                    });
                });

                document.getElementById('warehouseGrid').innerHTML = html;
            } catch (error) {
                console.error('Error loading warehouse map:', error);
            }
        }

        // ==================== AI COMMAND FUNCTIONS ====================
        async function sendAICommand() {
            const input = document.getElementById('aiCommandInput');
            const command = input.value.trim();

            if (!command) {
                showAlert('Please enter a command for the AI', 'info');
                return;
            }

            // Clear input and show loading
            input.value = '';
            document.getElementById('aiResponseContent').innerHTML = 
                '<div class="loading"><i class="fas fa-cog fa-spin"></i> AI is thinking...</div>';
            document.getElementById('responseTime').textContent = 'Processing...';

            try {
                const startTime = Date.now();
                const response = await fetch('/api/ai/command', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({command: command})
                });

                const result = await response.json();
                const responseTime = Date.now() - startTime;

                // Update AI response
                document.getElementById('aiResponseContent').innerHTML = result.ai_response;
                document.getElementById('responseTime').textContent = `${responseTime}ms`;

                // Show success alert
                if (result.updated_robots && result.updated_robots.length > 0) {
                    showAlert(`ü§ñ AI updated: ${result.updated_robots.join(', ')}`, 'success');
                }

                // Refresh data
                loadRobots();

            } catch (error) {
                document.getElementById('aiResponseContent').innerHTML = 
                    '‚ùå Error connecting to AI service. Using fallback responses.';
                document.getElementById('responseTime').textContent = 'Error';
                showAlert('AI service temporarily unavailable', 'error');
            }
        }

        function quickCommand(type) {
            const commands = {
                'battery': 'Give me a battery status report for all robots',
                'optimize': 'Optimize all robot routes for maximum efficiency',
                'emergency': 'Emergency stop all robots immediately',
                'analytics': 'Show me detailed warehouse analytics and predictions'
            };

            document.getElementById('aiCommandInput').value = commands[type];
            sendAICommand();
        }

        // ==================== SIMULATION FUNCTIONS ====================
        async function toggleSimulation() {
            const button = document.getElementById('simButton');
            const action = simulationActive ? 'stop' : 'start';

            try {
                const response = await fetch('/api/simulation/control', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({action: action})
                });

                const result = await response.json();

                if (action === 'start') {
                    simulationActive = true;
                    button.innerHTML = '<i class="fas fa-stop"></i> Stop Simulation';
                    button.className = 'btn-stop';
                    document.getElementById('simStatus').innerHTML = 
                        '<span class="status-indicator active"></span><span class="status-text">SIMULATION ACTIVE</span>';
                    showAlert('üöÄ AI Simulation Started! Real-time optimization active.', 'success');
                } else {
                    simulationActive = false;
                    button.innerHTML = '<i class="fas fa-play"></i> Start AI Simulation';
                    button.className = 'btn-start';
                    document.getElementById('simStatus').innerHTML = 
                        '<span class="status-indicator"></span><span class="status-text">SIMULATION READY</span>';
                    showAlert('‚èπÔ∏è Simulation Stopped. Final stats saved.', 'info');
                }

                loadRobots();
                loadWarehouseMap();

            } catch (error) {
                showAlert('Error controlling simulation', 'error');
            }
        }

        async function updateSimulationStats() {
            if (!simulationActive) return;

            try {
                const response = await fetch('/api/simulation/stats');
                const stats = await response.json();

                if (stats.is_running) {
                    document.getElementById('simRuntime').textContent = stats.runtime;
                    document.getElementById('simItems').textContent = stats.total_items.toLocaleString();
                    document.getElementById('simEnergy').textContent = `${stats.energy_saved} kWh`;
                    document.getElementById('itemsToday').textContent = stats.total_items.toLocaleString();
                }
            } catch (error) {
                console.error('Error updating simulation stats:', error);
            }
        }

        function assignRandomTask() {
            const robots = document.querySelectorAll('.robot-item');
            if (robots.length > 0) {
                const randomRobot = Math.floor(Math.random() * robots.length) + 1;
                const tasks = ['pick', 'move', 'charge', 'inspect'];
                const randomTask = tasks[Math.floor(Math.random() * tasks.length)];
                assignTaskToRobot(randomRobot, randomTask);
            }
        }

        // ==================== ANALYTICS FUNCTIONS ====================
        async function showAnalytics() {
            try {
                const response = await fetch('/api/analytics');
                const analytics = await response.json();

                let alertHtml = '';
                if (analytics.alerts && analytics.alerts.length > 0) {
                    analytics.alerts.forEach(alert => {
                        alertHtml += `<div class="alert-item ${alert.type}">
                            <i class="fas fa-${alert.type === 'warning' ? 'exclamation-triangle' : 'info-circle'}"></i>
                            ${alert.message}
                        </div>`;
                    });
                }

                document.getElementById('alertsContainer').innerHTML = alertHtml || 
                    '<div class="no-alerts">No active alerts. All systems nominal.</div>';

                // Update metrics
                document.querySelectorAll('.metric-value')[1].textContent = analytics.energy_efficiency;

            } catch (error) {
                console.error('Error loading analytics:', error);
            }
        }

        function updateAnalytics() {
            showAnalytics();
            showAlert('Analytics refreshed', 'info');
        }

        // ==================== SYSTEM HEALTH ====================
        async function checkSystemHealth() {
            try {
                const response = await fetch('/api/system/health');
                const health = await response.json();

                const healthElem = document.getElementById('systemHealth');
                if (health.status === 'healthy') {
                    healthElem.textContent = 'HEALTHY';
                    healthElem.style.color = '#10b981';
                } else {
                    healthElem.textContent = 'ISSUES';
                    healthElem.style.color = '#f59e0b';

                    if (canShowAlert()) {
                        showAlert('‚ö†Ô∏è System health check shows potential issues', 'warning');
                    }
                }

                document.getElementById('aiStatus').textContent = 
                    health.ai_service === 'operational' ? 'ACTIVE' : 'NEEDS CONFIG';

            } catch (error) {
                document.getElementById('systemHealth').textContent = 'OFFLINE';
                document.getElementById('systemHealth').style.color = '#ef4444';
            }
        }

        // ==================== ALERT SYSTEM ====================
        function canShowAlert() {
            const now = Date.now();
            if (now - lastAlertTime > alertCooldown) {
                lastAlertTime = now;
                return true;
            }
            return false;
        }

        function showAlert(message, type = 'info') {
            if (!canShowAlert()) return;

            const alertDiv = document.createElement('div');
            alertDiv.className = `alert-notification ${type}`;
            alertDiv.innerHTML = `
                <div class="alert-content">
                    <span class="alert-close" onclick="this.parentElement.parentElement.remove()">√ó</span>
                    <div class="alert-message">${message}</div>
                    <div class="alert-time">${new Date().toLocaleTimeString()}</div>
                </div>
            `;

            document.getElementById('alertContainer').appendChild(alertDiv);

            // Auto-remove after 5 seconds
            setTimeout(() => {
                if (alertDiv.parentElement) {
                    alertDiv.style.opacity = '0';
                    setTimeout(() => alertDiv.remove(), 300);
                }
            }, 5000);
        }

        // ==================== HELPER FUNCTIONS ====================
        function formatTime(date) {
            return date.toLocaleTimeString([], {hour: '2-digit', minute: '2-digit', second: '2-digit'});
        }
    </script>
</body>
</html>
