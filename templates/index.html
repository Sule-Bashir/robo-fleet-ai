<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ü§ñ RoboFleet AI Manager</title>
    <link rel="stylesheet" href="/static/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ü§ñ</text></svg>">
</head>
<body>
    <div class="container">
        <!-- Header -->
        <header class="dashboard-header">
            <div class="header-left">
                <h1><i class="fas fa-robot"></i> RoboFleet AI Manager</h1>
                <p class="subtitle">Digital Twin Dashboard for Smart Warehouse Operations</p>
            </div>
            <div class="header-right">
                <div class="simulation-status">
                    <span class="status-indicator"></span>
                    <span>SIMULATION READY</span>
                </div>
                <div class="time-display" id="currentTime">--:--:--</div>
            </div>
        </header>

        <!-- Stats Bar -->
        <div class="stats-bar">
            <div class="stat-card">
                <div class="stat-icon"><i class="fas fa-robot"></i></div>
                <div class="stat-content">
                    <div class="stat-value" id="totalRobots">4</div>
                    <div class="stat-label">Active Robots</div>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon"><i class="fas fa-battery-three-quarters"></i></div>
                <div class="stat-content">
                    <div class="stat-value" id="avgBattery">73%</div>
                    <div class="stat-label">Avg Battery</div>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon"><i class="fas fa-box"></i></div>
                <div class="stat-content">
                    <div class="stat-value" id="itemsToday">2,450</div>
                    <div class="stat-label">Items Today</div>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon"><i class="fas fa-brain"></i></div>
                <div class="stat-content">
                    <div class="stat-value" id="aiStatus">ACTIVE</div>
                    <div class="stat-label">AI Control</div>
                </div>
            </div>
        </div>

        <!-- Main Grid -->
        <div class="main-grid">
            <!-- Left Column -->
            <div class="left-column">
                <!-- Warehouse Map -->
                <div class="card">
                    <div class="card-header">
                        <h2><i class="fas fa-warehouse"></i> Warehouse Digital Twin</h2>
                        <button class="btn-refresh" onclick="loadMap()">
                            <i class="fas fa-sync-alt"></i> Refresh
                        </button>
                    </div>
                    <div class="map-container">
                        <div class="map-grid" id="warehouseMap">
                            <!-- Map will load here -->
                        </div>
                        <div class="legend">
                            <span class="legend-item"><span class="robot-color"></span> Robot</span>
                            <span class="legend-item"><span class="charging-color"></span> Charging</span>
                            <span class="legend-item"><span class="shelf-color"></span> Shelf</span>
                        </div>
                    </div>
                </div>

                <!-- AI Command Center -->
                <div class="card">
                    <div class="card-header">
                        <h2><i class="fas fa-comments"></i> AI Command Center</h2>
                    </div>
                    <div class="ai-input-group">
                        <input type="text" id="aiCommand" 
                               placeholder="Try: 'Check battery status' or 'Optimize routes'"
                               onkeypress="if(event.key=='Enter') sendAICommand()">
                        <button class="btn-send" onclick="sendAICommand()">
                            <i class="fas fa-paper-plane"></i> Send
                        </button>
                    </div>
                    <div class="ai-response" id="aiResponse">
                        Hello! I'm your AI fleet manager. Ready to optimize warehouse operations.
                    </div>
                    <div class="quick-commands">
                        <button class="quick-btn" onclick="quickCommand('battery')">
                            <i class="fas fa-battery-half"></i> Battery
                        </button>
                        <button class="quick-btn" onclick="quickCommand('optimize')">
                            <i class="fas fa-route"></i> Optimize
                        </button>
                        <button class="quick-btn" onclick="quickCommand('emergency')">
                            <i class="fas fa-exclamation-triangle"></i> Emergency
                        </button>
                        <button class="quick-btn" onclick="quickCommand('status')">
                            <i class="fas fa-chart-bar"></i> Status
                        </button>
                    </div>
                </div>
            </div>

            <!-- Right Column -->
            <div class="right-column">
                <!-- Robot Fleet -->
                <div class="card">
                    <div class="card-header">
                        <h2><i class="fas fa-list-alt"></i> Robot Fleet Status</h2>
                        <span class="last-update" id="robotUpdateTime">--:--:--</span>
                    </div>
                    <div class="fleet-container" id="robotList">
                        <!-- Robots load here -->
                    </div>
                </div>

                <!-- Simulation Controls -->
                <div class="card">
                    <div class="card-header">
                        <h2><i class="fas fa-gamepad"></i> Simulation Controls</h2>
                    </div>
                    <div class="controls-container">
                        <div class="control-buttons">
                            <button class="btn-start" onclick="toggleSimulation()" id="simBtn">
                                <i class="fas fa-play"></i> Start Simulation
                            </button>
                            <button class="btn-start" style="background:#8b5cf6" onclick="assignRandomTask()">
                                <i class="fas fa-random"></i> Random Task
                            </button>
                        </div>
                        <div class="simulation-stats">
                            <div class="sim-stat">
                                <div class="sim-label">Runtime</div>
                                <div class="sim-value" id="simRuntime">0m 0s</div>
                            </div>
                            <div class="sim-stat">
                                <div class="sim-label">Items</div>
                                <div class="sim-value" id="simItems">2,450</div>
                            </div>
                            <div class="sim-stat">
                                <div class="sim-label">Energy Saved</div>
                                <div class="sim-value" id="simEnergy">5.2 kWh</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Footer -->
        <footer class="dashboard-footer">
            <div class="footer-left">
                <p>Built for <strong>AI Meets Robotics Hackathon 2026</strong></p>
                <p>Flask ‚Ä¢ Digital Twin ‚Ä¢ AI-Powered Robotics</p>
            </div>
            <div class="footer-right">
                <div class="system-health">
                    <span class="status-indicator"></span>
                    <span>System: <strong>HEALTHY</strong></span>
                </div>
                <div class="last-update" id="lastUpdate">Last update: --:--:--</div>
            </div>
        </footer>
    </div>

    <!-- JavaScript -->
    <script>
        const API_URL = window.location.origin;
        let simRunning = false;

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            updateTime();
            loadRobots();
            loadMap();
            setInterval(updateTime, 1000);
            setInterval(loadRobots, 3000);
            setInterval(updateSimStats, 2000);
        });

        // Time functions
        function updateTime() {
            const now = new Date();
            const timeStr = now.toLocaleTimeString();
            document.getElementById('currentTime').textContent = timeStr;
            document.getElementById('lastUpdate').textContent = `Last update: ${timeStr}`;
        }

        // Load robots
        async function loadRobots() {
            try {
                const res = await fetch(API_URL + '/api/robots');
                const robots = await res.json();

                let html = '';
                let totalBattery = 0;

                robots.forEach(robot => {
                    let statusClass = '';
                    let statusIcon = '';

                    if (robot.status === 'working') {
                        statusClass = 'working';
                        statusIcon = 'üîÑ';
                    } else if (robot.status === 'charging') {
                        statusClass = 'charging';
                        statusIcon = 'üîã';
                    } else if (robot.status === 'maintenance') {
                        statusClass = 'maintenance';
                        statusIcon = 'üîß';
                    } else {
                        statusClass = 'idle';
                        statusIcon = '‚èπÔ∏è';
                    }

                    html += `
                    <div class="robot-item ${statusClass}">
                        <div class="robot-header">
                            <div class="robot-name">
                                <span>${statusIcon}</span>
                                <h3>${robot.name}</h3>
                                <span class="robot-type">${robot.type}</span>
                            </div>
                            <div class="robot-battery" style="background:${robot.battery > 50 ? '#10b98120' : robot.battery > 20 ? '#f59e0b20' : '#ef444420'};color:${robot.battery > 50 ? '#10b981' : robot.battery > 20 ? '#f59e0b' : '#ef4444'}">
                                ${robot.battery}%
                            </div>
                        </div>
                        <div class="robot-details">
                            <div><i class="fas fa-map-marker-alt"></i> ${robot.location}</div>
                            <div><i class="fas fa-tasks"></i> ${robot.task}</div>
                            <div><i class="fas fa-tachometer-alt"></i> ${robot.speed}</div>
                            <div><i class="fas fa-bolt"></i> ${robot.battery}%</div>
                        </div>
                        <div class="robot-actions">
                            <button class="action-btn" onclick="assignTask(${robot.id}, 'pick')" style="background:#10b98120;color:#10b981">Pick</button>
                            <button class="action-btn" onclick="assignTask(${robot.id}, 'move')" style="background:#3b82f620;color:#3b82f6">Move</button>
                            <button class="action-btn" onclick="assignTask(${robot.id}, 'charge')" style="background:#f59e0b20;color:#f59e0b">Charge</button>
                        </div>
                    </div>`;

                    totalBattery += robot.battery;
                });

                document.getElementById('robotList').innerHTML = html;
                document.getElementById('robotUpdateTime').textContent = new Date().toLocaleTimeString();
                document.getElementById('avgBattery').textContent = Math.round(totalBattery / robots.length) + '%';
                document.getElementById('totalRobots').textContent = robots.length;

            } catch (error) {
                console.log('Error loading robots:', error);
            }
        }

        // Load warehouse map
        async function loadMap() {
            try {
                const res = await fetch(API_URL + '/api/warehouse/map');
                const grid = await res.json();

                let html = '';
                grid.forEach(row => {
                    row.forEach(cell => {
                        let cellClass = 'map-cell';
                        let content = '';

                        if (cell.robot) {
                            cellClass += ' robot-cell';
                            content = 'ü§ñ';
                        } else if (cell.type === 'charging') {
                            cellClass += ' charging-cell';
                            content = '‚ö°';
                        } else if (cell.type === 'shelf') {
                            cellClass += ' shelf-cell';
                            content = cell.items > 5 ? 'üì¶' : 'üì¶';
                        }

                        html += `<div class="${cellClass}" title="${cell.id}">${content}</div>`;
                    });
                });

                document.getElementById('warehouseMap').innerHTML = html;
            } catch (error) {
                console.log('Error loading map:', error);
            }
        }

        // AI Commands
        async function sendAICommand() {
            const input = document.getElementById('aiCommand');
            const command = input.value.trim();

            if (!command) return;

            input.value = '';
            document.getElementById('aiResponse').innerHTML = '<i class="fas fa-cog fa-spin"></i> AI is thinking...';

            try {
                const res = await fetch(API_URL + '/api/ai/command', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({command: command})
                });

                const data = await res.json();
                document.getElementById('aiResponse').innerHTML = data.response;
                loadRobots(); // Refresh robots

            } catch (error) {
                document.getElementById('aiResponse').innerHTML = '‚ùå Error connecting to AI';
            }
        }

        function quickCommand(type) {
            const commands = {
                'battery': 'Check battery status for all robots',
                'optimize': 'Optimize robot routes for efficiency',
                'emergency': 'Emergency stop all robots',
                'status': 'Get system status report'
            };
            document.getElementById('aiCommand').value = commands[type];
            sendAICommand();
        }

        // Task assignment
        async function assignTask(robotId, taskType) {
            try {
                const res = await fetch(API_URL + '/api/task/assign', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({robot_id: robotId, task_type: taskType})
                });

                const data = await res.json();
                if (data.success) {
                    alert(`‚úÖ ${data.message}`);
                    loadRobots();
                }
            } catch (error) {
                alert('Error assigning task');
            }
        }

        function assignRandomTask() {
            const robotId = Math.floor(Math.random() * 4) + 1;
            const tasks = ['pick', 'move', 'charge', 'inspect'];
            const taskType = tasks[Math.floor(Math.random() * tasks.length)];
            assignTask(robotId, taskType);
        }

        // Simulation control
        async function toggleSimulation() {
            const action = simRunning ? 'stop' : 'start';
            const btn = document.getElementById('simBtn');

            try {
                const res = await fetch(API_URL + '/api/simulation/control', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({action: action})
                });

                const data = await res.json();
                if (data.status === 'started') {
                    simRunning = true;
                    btn.innerHTML = '<i class="fas fa-stop"></i> Stop Simulation';
                    btn.style.background = '#ef4444';
                    alert('üöÄ Simulation started!');
                } else {
                    simRunning = false;
                    btn.innerHTML = '<i class="fas fa-play"></i> Start Simulation';
                    btn.style.background = '#10b981';
                    alert('‚èπÔ∏è Simulation stopped');
                }

            } catch (error) {
                alert('Error controlling simulation');
            }
        }

        // Update simulation stats
        async function updateSimStats() {
            if (!simRunning) return;

            try {
                const res = await fetch(API_URL + '/api/simulation/stats');
                const stats = await res.json();

                document.getElementById('simRuntime').textContent = stats.runtime;
                document.getElementById('simItems').textContent = stats.total_items.toLocaleString();
                document.getElementById('simEnergy').textContent = `${stats.energy_saved} kWh`;
                document.getElementById('itemsToday').textContent = stats.total_items.toLocaleString();

            } catch (error) {
                console.log('Error updating stats:', error);
            }
        }
    </script>
</body>
</html>
