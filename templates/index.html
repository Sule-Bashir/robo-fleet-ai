<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ü§ñ RoboFleet AI Manager</title>
    <link rel="stylesheet" href="/static/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ü§ñ</text></svg>">
</head>
<body>
    <div class="container">
        <!-- Header -->
        <header class="dashboard-header">
            <div class="header-left">
                <h1><i class="fas fa-robot"></i> RoboFleet AI Manager</h1>
                <p class="subtitle">Digital Twin Dashboard for Smart Warehouse Operations</p>
            </div>
            <div class="header-right">
                <div class="simulation-status">
                    <span class="status-indicator" id="statusIndicator"></span>
                    <span id="simStatus">SIMULATION READY</span>
                </div>
                <div class="time-display" id="currentTime">--:--:--</div>
            </div>
        </header>

        <!-- Stats Bar -->
        <div class="stats-bar">
            <div class="stat-card">
                <div class="stat-icon"><i class="fas fa-robot"></i></div>
                <div class="stat-content">
                    <div class="stat-value" id="totalRobots">4</div>
                    <div class="stat-label">Active Robots</div>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon"><i class="fas fa-battery-three-quarters"></i></div>
                <div class="stat-content">
                    <div class="stat-value" id="avgBattery">73%</div>
                    <div class="stat-label">Avg Battery</div>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon"><i class="fas fa-box"></i></div>
                <div class="stat-content">
                    <div class="stat-value" id="itemsToday">2,450</div>
                    <div class="stat-label">Items Today</div>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon"><i class="fas fa-brain"></i></div>
                <div class="stat-content">
                    <div class="stat-value" id="aiStatus">ACTIVE</div>
                    <div class="stat-label">AI Control</div>
                </div>
            </div>
        </div>

        <!-- Main Grid -->
        <div class="main-grid">
            <!-- Left Column -->
            <div class="left-column">
                <!-- Warehouse Map -->
                <div class="card">
                    <div class="card-header">
                        <h2><i class="fas fa-warehouse"></i> Warehouse Digital Twin</h2>
                        <button class="btn-refresh" onclick="loadMap()">
                            <i class="fas fa-sync-alt"></i> Refresh
                        </button>
                    </div>
                    <div class="map-container">
                        <div class="map-grid" id="warehouseMap">
                            <!-- Map will load here -->
                        </div>
                        <div class="legend">
                            <span class="legend-item"><span class="robot-color"></span> Robot</span>
                            <span class="legend-item"><span class="charging-color"></span> Charging</span>
                            <span class="legend-item"><span class="shelf-color"></span> Shelf</span>
                            <span class="legend-item"><span class="storage-color"></span> Storage</span>
                        </div>
                    </div>
                </div>

                <!-- AI Command Center -->
                <div class="card">
                    <div class="card-header">
                        <h2><i class="fas fa-comments"></i> AI Command Center</h2>
                        <span class="vultr-badge">Powered by Vultr</span>
                    </div>
                    <div class="ai-input-group">
                        <input type="text" id="aiCommand" 
                               placeholder="Try: 'Check battery status' or 'Optimize routes'"
                               onkeypress="if(event.key=='Enter') sendAICommand()">
                        <button class="btn-send" onclick="sendAICommand()">
                            <i class="fas fa-paper-plane"></i> Send
                        </button>
                    </div>
                    <div class="ai-response" id="aiResponse">
                        <i class="fas fa-robot"></i> Hello! I'm your AI fleet manager powered by Vultr. Ready to optimize warehouse operations.
                    </div>
                    <div class="quick-commands">
                        <button class="quick-btn" onclick="quickCommand('battery')">
                            <i class="fas fa-battery-half"></i> Battery Report
                        </button>
                        <button class="quick-btn" onclick="quickCommand('optimize')">
                            <i class="fas fa-route"></i> Optimize Routes
                        </button>
                        <button class="quick-btn" onclick="quickCommand('emergency')">
                            <i class="fas fa-exclamation-triangle"></i> Emergency Stop
                        </button>
                        <button class="quick-btn" onclick="quickCommand('status')">
                            <i class="fas fa-chart-bar"></i> System Status
                        </button>
                    </div>
                </div>
            </div>

            <!-- Right Column -->
            <div class="right-column">
                <!-- Robot Fleet -->
                <div class="card">
                    <div class="card-header">
                        <h2><i class="fas fa-list-alt"></i> Robot Fleet Status</h2>
                        <span class="last-update" id="robotUpdateTime">--:--:--</span>
                    </div>
                    <div class="fleet-container" id="robotList">
                        <!-- Robots load here -->
                    </div>
                </div>

                <!-- Simulation Controls -->
                <div class="card">
                    <div class="card-header">
                        <h2><i class="fas fa-gamepad"></i> Simulation Controls</h2>
                    </div>
                    <div class="controls-container">
                        <div class="control-buttons">
                            <button class="btn-start" onclick="toggleSimulation()" id="simBtn">
                                <i class="fas fa-play"></i> Start Simulation
                            </button>
                            <button class="btn-start" style="background:linear-gradient(135deg,#8b5cf6,#7c3aed)" onclick="assignRandomTask()">
                                <i class="fas fa-random"></i> Random Task
                            </button>
                            <button class="btn-start emergency" onclick="emergencyStop()" id="emergencyBtn">
                                <i class="fas fa-exclamation-triangle"></i> Emergency Stop
                            </button>
                        </div>
                        <div class="simulation-stats">
                            <div class="sim-stat">
                                <div class="sim-label">Runtime</div>
                                <div class="sim-value" id="simRuntime">0m 0s</div>
                            </div>
                            <div class="sim-stat">
                                <div class="sim-label">Items</div>
                                <div class="sim-value" id="simItems">2,450</div>
                            </div>
                            <div class="sim-stat">
                                <div class="sim-label">Energy Saved</div>
                                <div class="sim-value" id="simEnergy">5.2 kWh</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Footer -->
        <footer class="dashboard-footer">
            <div class="footer-left">
                <p><strong>AI Meets Robotics Hackathon 2026</strong> | Track 3: Task Execution</p>
                <p>Flask ‚Ä¢ Digital Twin ‚Ä¢ AI-Powered Robotics ‚Ä¢ Vultr Backend</p>
            </div>
            <div class="footer-right">
                <div class="system-health">
                    <span class="status-indicator" id="healthIndicator"></span>
                    <span>System: <strong id="systemHealth">HEALTHY</strong></span>
                </div>
                <div class="last-update" id="lastUpdate">Last update: --:--:--</div>
                <div class="vultr-status">
                    <i class="fas fa-server"></i> Vultr Backend: <span id="vultrStatus">Connected</span>
                </div>
            </div>
        </footer>
    </div>

    <!-- JavaScript -->
    <script>
        const API_URL = window.location.origin;
        let simRunning = false;
        let emergencyMode = false;
        let currentTasks = {};

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            updateTime();
            loadRobots();
            loadMap();
            updateSystemHealth();

            // Set up intervals
            setInterval(updateTime, 1000);
            setInterval(loadRobots, 3000);
            setInterval(updateSimStats, 2000);
            setInterval(updateSystemHealth, 5000);

            // Test Vultr connection
            testVultrConnection();
        });

        // Time functions
        function updateTime() {
            const now = new Date();
            const timeStr = now.toLocaleTimeString();
            document.getElementById('currentTime').textContent = timeStr;
            document.getElementById('lastUpdate').textContent = `Last update: ${timeStr}`;
        }

        // Test Vultr connection
        async function testVultrConnection() {
            try {
                const res = await fetch(API_URL + '/api/vultr/info');
                const data = await res.json();
                document.getElementById('vultrStatus').textContent = data.status;
                document.getElementById('vultrStatus').style.color = '#10b981';
            } catch (error) {
                document.getElementById('vultrStatus').textContent = 'Disconnected';
                document.getElementById('vultrStatus').style.color = '#ef4444';
            }
        }

        // Load robots with enhanced visuals
        async function loadRobots() {
            try {
                const res = await fetch(API_URL + '/api/robots');
                const data = await res.json();
                const robots = data.robots;
                const taskData = data.task_execution;

                let html = '';
                let totalBattery = 0;
                let workingRobots = 0;

                robots.forEach(robot => {
                    const status = robot.status;
                    const battery = robot.battery;

                    // Count working robots
                    if (status === 'working') workingRobots++;

                    totalBattery += battery;

                    let statusIcon = '';
                    let statusText = '';
                    let batteryClass = '';

                    switch(status) {
                        case 'working':
                            statusIcon = 'üîÑ';
                            statusText = 'Working';
                            break;
                        case 'charging':
                            statusIcon = 'üîã';
                            statusText = 'Charging';
                            break;
                        case 'maintenance':
                            statusIcon = 'üîß';
                            statusText = 'Maintenance';
                            break;
                        default:
                            statusIcon = '‚èπÔ∏è';
                            statusText = 'Idle';
                    }

                    // Determine battery color class
                    if (battery > 70) batteryClass = 'high';
                    else if (battery > 30) batteryClass = 'medium';
                    else batteryClass = 'low';

                    // Get task progress if available
                    const progress = taskData[robot.id] ? taskData[robot.id].progress : 0;
                    const taskType = taskData[robot.id] ? taskData[robot.id].current_task : 'none';

                    html += `
                    <div class="robot-item ${status}">
                        <div class="robot-header">
                            <div class="robot-name">
                                <span style="font-size:1.5rem">${statusIcon}</span>
                                <div>
                                    <h3>${robot.name}</h3>
                                    <span class="robot-type">${robot.type}</span>
                                </div>
                            </div>
                            <div>
                                <div class="robot-battery" style="background:${battery > 70 ? '#10b98120' : battery > 30 ? '#f59e0b20' : '#ef444420'};color:${battery > 70 ? '#10b981' : battery > 30 ? '#f59e0b' : '#ef4444'}">
                                    ${battery}%
                                </div>
                                <div class="battery-container">
                                    <div class="battery-bar">
                                        <div class="battery-level ${batteryClass}" style="width:${battery}%"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="robot-details">
                            <div><i class="fas fa-map-marker-alt"></i> ${robot.location}</div>
                            <div><i class="fas fa-tasks"></i> ${robot.task}</div>
                            <div><i class="fas fa-tachometer-alt"></i> ${robot.speed}</div>
                            <div><i class="fas fa-bolt"></i> ${battery}% remaining</div>
                        </div>
                        ${progress > 0 ? `
                        <div class="task-progress">
                            <small>${taskType} progress: ${progress}%</small>
                            <div class="progress-bar">
                                <div class="progress-fill" style="width:${progress}%"></div>
                            </div>
                        </div>
                        ` : ''}
                        <div class="robot-actions">
                            <button class="action-btn" onclick="assignTask(${robot.id}, 'pick')" style="background:#10b98120;color:#10b981;border:1px solid #10b981">
                                <i class="fas fa-hand-paper"></i> Pick
                            </button>
                            <button class="action-btn" onclick="assignTask(${robot.id}, 'move')" style="background:#3b82f620;color:#3b82f6;border:1px solid #3b82f6">
                                <i class="fas fa-truck"></i> Move
                            </button>
                            <button class="action-btn" onclick="assignTask(${robot.id}, 'charge')" style="background:#f59e0b20;color:#f59e0b;border:1px solid #f59e0b">
                                <i class="fas fa-charging-station"></i> Charge
                            </button>
                        </div>
                    </div>`;
                });

                document.getElementById('robotList').innerHTML = html;
                document.getElementById('robotUpdateTime').textContent = new Date().toLocaleTimeString();
                document.getElementById('avgBattery').textContent = Math.round(totalBattery / robots.length) + '%';
                document.getElementById('totalRobots').textContent = workingRobots;
                document.getElementById('aiStatus').textContent = workingRobots > 0 ? 'ACTIVE' : 'IDLE';

            } catch (error) {
                console.log('Error loading robots:', error);
            }
        }

        // Load warehouse map with real positions
        async function loadMap() {
            try {
                const res = await fetch(API_URL + '/api/warehouse/map');
                const grid = await res.json();

                let html = '';
                grid.forEach(row => {
                    row.forEach(cell => {
                        let cellClass = 'map-cell';
                        let content = '';

                        if (cell.has_robot) {
                            cellClass += ' robot-cell';
                            content = 'ü§ñ';
                        } else if (cell.cell_type === 'charging') {
                            cellClass += ' charging-cell';
                            content = '‚ö°';
                        } else if (cell.cell_type === 'shelf') {
                            cellClass += ' shelf-cell';
                            content = cell.item_count > 10 ? 'üì¶üì¶' : 'üì¶';
                        } else if (cell.cell_type === 'storage') {
                            cellClass += ' storage-cell';
                            content = 'üì¶';
                        } else if (cell.cell_type === 'packing') {
                            cellClass += ' packing-cell';
                            content = 'üìã';
                        } else {
                            cellClass += ' aisle-cell';
                            content = '¬∑';
                        }

                        html += `<div class="${cellClass}" title="${cell.label} - ${cell.cell_type}">${content}</div>`;
                    });
                });

                document.getElementById('warehouseMap').innerHTML = html;
            } catch (error) {
                console.log('Error loading map:', error);
            }
        }

        // AI Commands with Vultr processing
        async function sendAICommand() {
            const input = document.getElementById('aiCommand');
            const command = input.value.trim();

            if (!command) return;

            input.value = '';
            document.getElementById('aiResponse').innerHTML = '<i class="fas fa-cog fa-spin"></i> AI processing via Vultr...';

            try {
                const res = await fetch(API_URL + '/api/ai/command', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({command: command})
                });

                const data = await res.json();
                document.getElementById('aiResponse').innerHTML = data.ai_response;

                // Update emergency mode if needed
                if (data.emergency_mode !== undefined) {
                    emergencyMode = data.emergency_mode;
                    updateEmergencyUI();
                }

                loadRobots(); // Refresh robots
                loadMap(); // Refresh map if needed

            } catch (error) {
                document.getElementById('aiResponse').innerHTML = '‚ùå Error connecting to Vultr AI backend';
            }
        }

        function quickCommand(type) {
            const commands = {
                'battery': 'Check battery status for all robots',
                'optimize': 'Optimize robot routes for maximum efficiency',
                'emergency': 'Emergency stop all robots immediately',
                'status': 'Get complete system status report',
                'charge': 'Prioritize charging for low battery robots',
                'task': 'Show task execution statistics'
            };
            document.getElementById('aiCommand').value = commands[type];
            sendAICommand();
        }

        // Task assignment with progress tracking
        async function assignTask(robotId, taskType) {
            if (emergencyMode) {
                alert('üö® Cannot assign tasks during emergency stop');
                return;
            }

            try {
                const res = await fetch(API_URL + '/api/task/assign', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({robot_id: robotId, task_type: taskType})
                });

                const data = await res.json();
                if (data.success) {
                    // Show success notification
                    document.getElementById('aiResponse').innerHTML = `‚úÖ ${data.message}<br>${data.ai_optimization}`;
                    loadRobots();
                    loadMap();

                    // Store task for progress tracking
                    currentTasks[robotId] = {
                        type: taskType,
                        startTime: new Date(),
                        estimatedDuration: data.estimated_duration
                    };
                } else {
                    alert(data.message);
                }
            } catch (error) {
                alert('‚ùå Error assigning task via Vultr backend');
            }
        }

        function assignRandomTask() {
            const robotId = Math.floor(Math.random() * 4) + 1;
            const tasks = ['pick', 'move', 'charge', 'inspect'];
            const taskType = tasks[Math.floor(Math.random() * tasks.length)];
            assignTask(robotId, taskType);
        }

        // Simulation control
        async function toggleSimulation() {
            if (emergencyMode) {
                alert('üö® Cannot start simulation during emergency stop');
                return;
            }

            const action = simRunning ? 'stop' : 'start';
            const btn = document.getElementById('simBtn');

            try {
                const res = await fetch(API_URL + '/api/simulation/control', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({action: action})
                });

                const data = await res.json();
                if (data.status === 'started') {
                    simRunning = true;
                    btn.innerHTML = '<i class="fas fa-stop"></i> Stop Simulation';
                    btn.style.background = 'linear-gradient(135deg, #ef4444, #dc2626)';
                    document.getElementById('simStatus').textContent = 'SIMULATION RUNNING';
                    document.getElementById('statusIndicator').style.background = '#3b82f6';
                } else if (data.status === 'stopped') {
                    simRunning = false;
                    btn.innerHTML = '<i class="fas fa-play"></i> Start Simulation';
                    btn.style.background = 'linear-gradient(135deg, #10b981, #059669)';
                    document.getElementById('simStatus').textContent = 'SIMULATION READY';
                    document.getElementById('statusIndicator').style.background = '#10b981';
                }

                loadRobots();

            } catch (error) {
                alert('Error controlling simulation via Vultr');
            }
        }

        // Emergency stop
        async function emergencyStop() {
            try {
                const res = await fetch(API_URL + '/api/simulation/control', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({action: 'emergency_stop'})
                });

                const data = await res.json();
                if (data.status === 'emergency') {
                    emergencyMode = true;
                    simRunning = false;
                    updateEmergencyUI();
                    document.getElementById('aiResponse').innerHTML = 'üö® ' + data.message;
                    loadRobots();
                }
            } catch (error) {
                alert('Error activating emergency stop');
            }
        }

        // Clear emergency
        async function clearEmergency() {
            try {
                const res = await fetch(API_URL + '/api/simulation/control', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({action: 'clear_emergency'})
                });

                const data = await res.json();
                if (data.status === 'resumed') {
                    emergencyMode = false;
                    updateEmergencyUI();
                    document.getElementById('aiResponse').innerHTML = '‚úÖ ' + data.message;
                    loadRobots();
                }
            } catch (error) {
                alert('Error clearing emergency');
            }
        }

        function updateEmergencyUI() {
            const statusIndicator = document.getElementById('statusIndicator');
            const simStatus = document.getElementById('simStatus');
            const systemHealth = document.getElementById('systemHealth');
            const healthIndicator = document.getElementById('healthIndicator');

            if (emergencyMode) {
                statusIndicator.className = 'status-indicator emergency';
                simStatus.textContent = 'EMERGENCY STOP';
                simStatus.style.color = '#ef4444';
                systemHealth.textContent = 'EMERGENCY';
                systemHealth.style.color = '#ef4444';
                healthIndicator.className = 'status-indicator emergency';

                // Update simulation button
                const simBtn = document.getElementById('simBtn');
                simBtn.innerHTML = '<i class="fas fa-play"></i> Start Simulation';
                simBtn.style.background = 'linear-gradient(135deg, #10b981, #059669)';
                simBtn.disabled = true;

                // Add clear emergency button
                if (!document.getElementById('clearEmergencyBtn')) {
                    const emergencyBtn = document.getElementById('emergencyBtn');
                    const clearBtn = document.createElement('button');
                    clearBtn.id = 'clearEmergencyBtn';
                    clearBtn.className = 'btn-start';
                    clearBtn.style.background = 'linear-gradient(135deg, #10b981, #059669)';
                    clearBtn.innerHTML = '<i class="fas fa-check-circle"></i> Clear Emergency';
                    clearBtn.onclick = clearEmergency;
                    emergencyBtn.parentNode.insertBefore(clearBtn, emergencyBtn.nextSibling);
                }
            } else {
                statusIndicator.className = 'status-indicator';
                simStatus.textContent = simRunning ? 'SIMULATION RUNNING' : 'SIMULATION READY';
                simStatus.style.color = simRunning ? '#3b82f6' : '#10b981';
                systemHealth.textContent = 'HEALTHY';
                systemHealth.style.color = '#10b981';
                healthIndicator.className = 'status-indicator';

                // Enable simulation button
                const simBtn = document.getElementById('simBtn');
                simBtn.disabled = false;

                // Remove clear emergency button
                const clearBtn = document.getElementById('clearEmergencyBtn');
                if (clearBtn) clearBtn.remove();
            }
        }

        // Update simulation stats
        async function updateSimStats() {
            try {
                const res = await fetch(API_URL + '/api/simulation/stats');
                const stats = await res.json();

                document.getElementById('simRuntime').textContent = stats.runtime;
                document.getElementById('simItems').textContent = stats.total_items.toLocaleString();
                document.getElementById('simEnergy').textContent = `${stats.energy_saved} kWh`;
                document.getElementById('itemsToday').textContent = stats.total_items.toLocaleString();

                // Update emergency mode
                if (stats.emergency_mode !== undefined && stats.emergency_mode !== emergencyMode) {
                    emergencyMode = stats.emergency_mode;
                    updateEmergencyUI();
                }

            } catch (error) {
                console.log('Error updating stats:', error);
            }
        }

        // Update system health
        async function updateSystemHealth() {
            try {
                const res = await fetch(API_URL + '/api/system/health');
                const health = await res.json();

                document.getElementById('systemHealth').textContent = health.status.toUpperCase();
                document.getElementById('systemHealth').style.color = health.status === 'healthy' ? '#10b981' : '#ef4444';

                const indicator = document.getElementById('healthIndicator');
                indicator.style.background = health.status === 'healthy' ? '#10b981' : '#ef4444';

            } catch (error) {
                console.log('Error updating system health:', error);
            }
        }
    </script>
</body>
</html>
